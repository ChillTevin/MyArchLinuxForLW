#!/bin/bash

# --- Configuración de Colores ---
VIOLET='\033[38;5;93m'
CYAN='\033[38;5;51m'
GOLD='\033[38;5;220m'
WHITE='\033[38;5;255m'
RED='\033[38;5;196m'
GREEN='\033[38;5;82m'
RESET='\033[0m'
BOLD='\033[1m'

ROOTFS_DIR=$(pwd)
ARCH=$(uname -m)

# --- Banner Visual ---
clear
echo -e "${VIOLET}${BOLD}┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓"
echo -e "┃                ${WHITE}T  O  M  E  X   ARCH${VIOLET}                 ┃"
echo -e "┃             ${CYAN}SYSTEM BOOTSTRAP V11.0${VIOLET}                   ┃"
echo -e "┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛${RESET}"

# 1. TEST DE CONEXIÓN INICIAL
echo -ne "${CYAN}➜ Verificando conexión a internet... ${RESET}"
if ! ping -c 1 8.8.8.8 &>/dev/null; then
    echo -e "${RED}ERROR: Sin internet.${RESET}"
    echo -e "${GOLD}Prueba configurar DNS: echo \"nameserver 8.8.8.8\" > /etc/resolv.conf${RESET}"
    exit 1
fi
echo -e "${GREEN}OK${RESET}"

# 2. SINCRONIZACIÓN DE HORA (Evita errores SSL)
echo -ne "${CYAN}➜ Sincronizando reloj del sistema... ${RESET}"
date -s "$(curl -sD - http://google.com | grep ^Date: | cut -d' ' -f3-6)Z" &>/dev/null
echo -e "${GREEN}OK${RESET}"

# 3. CONFIGURACIÓN DE URLS (Basadas en mirrors dinámicos)
if [ "$ARCH" = "x86_64" ]; then
    # Buscamos en el mirror de Linux y otros mirrors robustos
    MIRRORS=(
        "https://mirrors.edge.kernel.org/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
        "http://archlinux.mirror.constant.com/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
        "https://archive.archlinux.org/iso/latest/archlinux-bootstrap-x86_64.tar.gz"
    )
    STRIP_COMPONENTS=1
elif [ "$ARCH" = "aarch64" ]; then
    MIRRORS=(
        "http://os.archlinuxarm.org/os/ArchLinuxARM-aarch64-latest.tar.gz"
        "http://mirror.archlinuxarm.org/os/ArchLinuxARM-aarch64-latest.tar.gz"
    )
    STRIP_COMPONENTS=0
fi

if [ ! -e "$ROOTFS_DIR/.installed" ]; then
    echo -e "${GOLD}¿Instalar Arch Linux? (s/n): ${RESET}"
    read -p ">> " confirm
    [[ ! $confirm =~ ^[sS]$ ]] && exit 0

    # 4. LÓGICA DE DESCARGA HÍBRIDA (WGET + CURL)
    SUCCESS=false
    for URL in "${MIRRORS[@]}"; do
        echo -e "${CYAN}➜ Intentando: ${WHITE}$URL${RESET}"
        
        # Intentar con WGET
        if wget --no-check-certificate -q --show-progress --timeout=10 "$URL" -O arch_rootfs.tar.gz; then
            SUCCESS=true; break
        fi
        
        # Intentar con CURL si wget falla
        if curl -L --insecure --connect-timeout 10 "$URL" -o arch_rootfs.tar.gz; then
            SUCCESS=true; break
        fi
        
        echo -e "${RED}✘ Fallo en este mirror.${RESET}"
    done

    if [ "$SUCCESS" = false ]; then
        echo -e "${RED}${BOLD}✘ ERROR: Los servidores de Arch no responden o bloquean la conexión.${RESET}"
        echo -e "${GOLD}INTENTA ESTO:${RESET} Ejecuta el comando manual:"
        echo -e "curl -L http://os.archlinuxarm.org/os/ArchLinuxARM-aarch64-latest.tar.gz -o arch.tar.gz"
        exit 1
    fi

    # 5. EXTRACCIÓN Y CONFIGURACIÓN
    echo -e "${CYAN}➜ Extrayendo RootFS...${RESET}"
    tar -xf arch_rootfs.tar.gz -C "$ROOTFS_DIR" --strip-components=$STRIP_COMPONENTS 2>/dev/null
    rm arch_rootfs.tar.gz

    # Configurar PRoot
    echo -e "${CYAN}➜ Descargando motor PRoot...${RESET}"
    PROOT_URL="https://raw.githubusercontent.com/foxytouxxx/freeroot/main/proot-${ARCH}"
    curl -L --insecure "$PROOT_URL" -o "$ROOTFS_DIR/usr/local/bin/proot" || wget --no-check-certificate "$PROOT_URL" -O "$ROOTFS_DIR/usr/local/bin/proot"
    chmod 755 "$ROOTFS_DIR/usr/local/bin/proot"

    # DNS
    printf "nameserver 1.1.1.1\nnameserver 8.8.8.8" > "$ROOTFS_DIR/etc/resolv.conf"
    
    # Marcador de éxito
    touch "$ROOTFS_DIR/.installed"
    echo -e "${GREEN}✔ Instalación finalizada.${RESET}"
fi

# 6. ENTRAR AL ENTORNO
echo -e "${VIOLET}➜ Iniciando Arch Linux...${RESET}"
"$ROOTFS_DIR/usr/local/bin/proot" \
    --rootfs="$ROOTFS_DIR" \
    -0 -w "/root" \
    -b /dev -b /sys -b /proc -b /etc/resolv.conf \
    --kill-on-exit \
    /bin/bash
